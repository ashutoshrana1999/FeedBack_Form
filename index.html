<script>
// Configuration - Web App URL for fetching project data
const PROJECT_DATA_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw7v9uappRW17ish0rJjkeLMHEwkGUP6UrvP2UGs4VbjgkW5Cb0g0ZEcIN49NX93Q/exec';

// Web App URL for submitting feedback (keep this for later use)
const FEEDBACK_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwIn5Ima-axKANo-9VdxNGyOjFpzExWHUqFV8pFPKoBGVR1e9wH_z8wPhfjBf0xFfw/exec';

// Global variable to store current project data
let currentProjectData = {};

// Utility Functions
function getQueryParam(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
}

function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

function showError(message, isFatal = false) {
  document.getElementById('loading-spinner').style.display = 'none';
  const err = document.getElementById('error-message');
  err.style.display = 'block';
  err.innerHTML = message;
  
  if (isFatal) {
    err.style.color = 'red';
    err.innerHTML += '<br><button onclick="location.reload()" class="btn btn-sm btn-outline-secondary mt-2">Retry</button>';
  }
}

function setLoadingState(loading) {
  const submitBtn = document.getElementById('submit-button');
  if (loading) {
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading-spinner"></span> Submitting...';
  } else {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit Feedback';
  }
}

// Parse the p parameter to extract client and project codes
function parseProjectFromUrl() {
  const pParam = getQueryParam('p');
  if (!pParam) return null;
  
  console.log("p parameter found:", pParam);
  
  // Expected format: /2535549/1111111
  // Remove leading and trailing slashes and split
  const cleanParam = pParam.replace(/^\/+|\/+$/g, '');
  const parts = cleanParam.split('/').filter(part => part.trim() !== '');
  
  console.log("Parsed parts:", parts);
  
  if (parts.length >= 2) {
    return {
      clientCode: parts[0],
      projectCode: parts[1]
    };
  }
  return null;
}

// Form Validation
function validateForm() {
  let isValid = true;
  
  const requiredFields = [
    'overallRating',
    'qualityRating', 
    'timelinessRating',
    'communicationRating',
    'valueRating'
  ];
  
  requiredFields.forEach(field => {
    const checked = document.querySelector(`input[name="${field}"]:checked`);
    const errorElement = document.getElementById(`${field}Error`);
    
    if (!checked) {
      errorElement.style.display = 'block';
      isValid = false;
    } else {
      errorElement.style.display = 'none';
    }
  });
  
  return isValid;
}

// Project Data Loading from Web App
async function loadProjectFromWebApp() {
  const urlProject = parseProjectFromUrl();
  
  if (!urlProject) {
    showError('No project specified in URL. Please use a valid project URL with the "p" parameter.');
    return;
  }

  try {
    // Build the URL with project parameter for the web app
    const url = `${PROJECT_DATA_WEB_APP_URL}?project=${encodeURIComponent(urlProject.projectCode)}`;
    console.log("Fetching project data from:", url);
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const projectData = await response.json();
    
    if (projectData.error) {
      showError(`Error: ${projectData.error}`);
      return;
    }
    
    console.log("Project data received:", projectData);
    displayProjectData(projectData);
    
  } catch (error) {
    console.error('Error fetching project data:', error);
    showError('Unable to fetch project data. Please check the project URL and try again.', true);
  }
}

function displayProjectData(project) {
  const projectNameEl = document.getElementById('project-name');
  const projectParagraphEl = document.getElementById('project-paragraph');
  
  // Use project title if present for heading
  const heading = project.Title || project["Project Title"] || project["Project Code"] || 'Unnamed Project';
  projectNameEl.textContent = heading;

  // Generate the dynamic paragraph based on project_type
  const paragraphHtml = generateProjectParagraph(project);

  // Store project data for form submission
  currentProjectData = project;

  projectParagraphEl.innerHTML = paragraphHtml;
  
  document.getElementById('loading-spinner').style.display = 'none';
  document.getElementById('feedback-container').style.display = 'block';
}

// Generate project paragraph content
function generateProjectParagraph(project) {
  const type = (project["Project Type"] || project.projectType || '').toString().trim();
  const code = project["Project Code"] || project.projectCode || '';
  const client = project["Client Code"] || project.clientCode || '';
  const title = project.Title || project["Project Title"] || '';
  const patent = project["Patent Number"] || project.patentNumber || '';
  const product = project["Product Name"] || project.productName || '';

  console.log("Generating paragraph for project type:", type);

  // Use the projectParagraph from the web app if available
  if (project.projectParagraph && project.projectParagraph !== "No paragraph available for this project type.") {
    return `
      <p>${project.projectParagraph}</p>
      
      <p><strong>Project Details:</strong><br>
      Project Code: ${escapeHtml(code)}<br>
      Client Code: ${escapeHtml(client)}<br>
      Type: ${escapeHtml(type || 'Unknown')}<br>
      Project Title: ${escapeHtml(title)}${patent ? `<br>Patent Number: ${escapeHtml(patent)}` : ''}${product ? `<br>Product Name: ${escapeHtml(product)}` : ''}</p>

      <p>Thank you for your valuable partnership.</p>
    `;
  }

  // Normalize for matching
  const t = type.toLowerCase();
  
  if (t.includes('patentability') || t.includes('patentibility') || (t.includes('patent') && (t.includes('search') || t.includes('analysis')))) {
    return `
      <p>Thank you for collaborating with us on this Patentability Search project.<br>
      Your insights help us assess the inventive step and novelty with accuracy.<br>
      Please provide your feedback to help us improve our search strategies.</p>

      <p><strong>Project Details:</strong><br>
      Project Code: ${escapeHtml(code)}<br>
      Client Code: ${escapeHtml(client)}<br>
      Type: Patentability Search<br>
      Project Title: ${escapeHtml(title)}${patent ? `<br>Patent Number: ${escapeHtml(patent)}` : ''}</p>

      <p>Thank you for your valuable partnership.</p>
    `;
  } else if (t.includes('invalidation') || t.includes('invalidity') || t.includes('opposition')) {
    return `
      <p>We appreciate the opportunity to support you in this Invalidation Search project.<br>
      Your feedback helps us refine our methodology for identifying prior art and analysing patent strength.</p>

      <p><strong>Project Details:</strong><br>
      Project Code: ${escapeHtml(code)}<br>
      Client Code: ${escapeHtml(client)}<br>
      Type: Invalidation Search<br>
      Project Title: ${escapeHtml(title)}<br>
      Patent Number: ${escapeHtml(patent)}</p>

      <p>Thank you for trusting our expertise.</p>
    `;
  } else if (t.includes('infringement') || t.includes('infringment') || t.includes('freedom') || t.includes('f-to-operate') || t.includes('clearance')) {
    return `
      <p>Thank you for working with us on this Infringement Study project.<br>
      Your feedback enables us to improve our evaluation of claim mapping and product analysis.</p>

      <p><strong>Project Details:</strong><br>
      Project Code: ${escapeHtml(code)}<br>
      Client Code: ${escapeHtml(client)}<br>
      Type: Infringement Study<br>
      Project Title: ${escapeHtml(title)}<br>
      Patent Number: ${escapeHtml(patent)}<br>
      Product Name: ${escapeHtml(product)}</p>

      <p>We appreciate your continued collaboration.</p>
    `;
  } else {
    // Generic fallback
    return `
      <p>Thank you for collaborating with us on this project.<br>
      Your feedback helps us improve our services and deliver better results.</p>
      
      <p><strong>Project Details:</strong><br>
      Project Code: ${escapeHtml(code)}<br>
      Client Code: ${escapeHtml(client)}<br>
      Type: ${escapeHtml(type || 'Unknown')}<br>
      Project Title: ${escapeHtml(title)}${patent ? `<br>Patent Number: ${escapeHtml(patent)}` : ''}${product ? `<br>Product Name: ${escapeHtml(product)}` : ''}</p>

      <p>Thank you for your valuable partnership.</p>
    `;
  }
}

// Thank You Page
function showThankYouPage() {
  document.getElementById('feedback-container').style.display = 'none';
  
  // Calculate stats from stored feedback
  const storedFeedback = JSON.parse(localStorage.getItem('logicapt_feedback') || '[]');
  const totalSubmissions = storedFeedback.length;
  
  // Calculate average overall rating
  let totalRating = 0;
  let validRatings = 0;
  
  storedFeedback.forEach(feedback => {
    if (feedback.overall_rating) {
      totalRating += parseInt(feedback.overall_rating);
      validRatings++;
    }
  });
  
  const avgRating = validRatings > 0 ? (totalRating / validRatings).toFixed(1) : '0';
  
  document.getElementById('total-submissions').textContent = totalSubmissions;
  document.getElementById('avg-rating').textContent = avgRating;
  document.getElementById('thank-you-container').style.display = 'block';
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
  // Load project data from Web App
  loadProjectFromWebApp();
  
  // Form submission handler
  document.getElementById('feedbackForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!validateForm()) {
      // Scroll to first error
      const firstError = document.querySelector('.error-message[style="display: block"]');
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      return;
    }
    
    // Collect form data
    const formData = {
      overallRating: document.querySelector('input[name="overallRating"]:checked').value,
      qualityRating: document.querySelector('input[name="qualityRating"]:checked').value,
      timelinessRating: document.querySelector('input[name="timelinessRating"]:checked').value,
      communicationRating: document.querySelector('input[name="communicationRating"]:checked').value,
      valueRating: document.querySelector('input[name="valueRating"]:checked').value,
      comments: document.getElementById('comments').value
    };
    
    // For now, just store in localStorage and show thank you page
    // You'll add the actual submission logic later
    try {
      const storedFeedback = JSON.parse(localStorage.getItem('logicapt_feedback') || '[]');
      const currentProject = document.getElementById('project-name').innerText;
      
      const feedbackData = {
        ...formData,
        timestamp: new Date().toISOString(),
        project: currentProject,
        projectCode: currentProjectData["Project Code"] || currentProjectData.projectCode || '',
        clientCode: currentProjectData["Client Code"] || currentProjectData.clientCode || '',
        projectType: currentProjectData["Project Type"] || currentProjectData.projectType || ''
      };
      
      storedFeedback.push(feedbackData);
      localStorage.setItem('logicapt_feedback', JSON.stringify(storedFeedback));
      
      console.log('Feedback saved to localStorage:', feedbackData);
      showThankYouPage();
    } catch (error) {
      alert('Error saving feedback: ' + error.message);
    }
  });
  
  // Real-time validation for radio buttons
  const radioGroups = document.querySelectorAll('input[type="radio"]');
  radioGroups.forEach(radio => {
    radio.addEventListener('change', function() {
      const fieldName = this.name;
      const errorElement = document.getElementById(`${fieldName}Error`);
      if (errorElement) {
        errorElement.style.display = 'none';
      }
    });
  });
});
</script>
