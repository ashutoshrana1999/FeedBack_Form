<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LogicApt - Client Feedback Form</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root {
      --primary-color: #ff7f27;
      --secondary-color: #333;
      --background-color: #f5f6fa;
      --card-shadow: 0 3px 8px rgba(0,0,0,0.08);
    }
    
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background-color: var(--background-color);
      color: var(--secondary-color);
    }

    a { text-decoration: none; }

    /* TOP BAR */
    .top-nav {
      background: #000;
      color: #fff;
      padding: 8px 0;
      font-size: 14px;
      border-bottom: 1px solid #222;
    }

    .top-nav a {
      color: #c8cdd6;
      margin-right: 20px;
      transition: color 0.3s;
    }
    
    .top-nav a:hover {
      color: #fff;
    }

    .circle-icon {
      width: 28px;
      height: 28px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      color: #fff;
      font-size: 13px;
      margin-left: 10px;
      transition: all 0.3s;
    }
    
    .circle-icon:hover {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    /* HEADER */
    header {
      background: #fff;
      padding: 15px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .logo { height: 70px; }

    h1 {
      color: var(--primary-color);
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }

    /* CARD */
    .form-card {
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      margin-bottom: 30px;
    }

    /* Fade-in animation */
    .fade-in {
      opacity: 0;
      animation: fadeIn 0.9s forwards ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* FIX: GAP BETWEEN HEADER & FIRST CARD */
    .first-section {
      margin-top: 40px;
    }

    /* Form Styles */
    .rating-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .form-check-inline {
      margin-right: 0;
    }
    
    .form-check-input:checked {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    .form-check-label {
      margin-left: 5px;
    }
    
    .error-message {
      color: #dc3545;
      font-size: 0.875em;
      margin-top: 5px;
      display: none;
    }
    
    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(255, 127, 39, 0.25);
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    .btn-primary:hover, .btn-primary:focus {
      background-color: #e67322;
      border-color: #e67322;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* FOOTER */
    footer {
      background: #fff;
      padding: 60px 0 30px 0;
      border-top: 1px solid #ddd;
      margin-top: 70px;
    }

    .footer-social a {
      border: 2px solid var(--primary-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      margin-right: 12px;
      color: var(--primary-color);
      font-size: 17px;
      transition: all 0.3s;
    }
    
    .footer-social a:hover {
      background-color: var(--primary-color);
      color: white;
    }

    .footer-bottom {
      text-align: center;
      margin-top: 30px;
      color: #666;
      font-size: 14px;
    }
    
    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .form-card {
        padding: 20px 15px;
      }
      
      .col-md-4.fw-bold {
        margin-bottom: 10px;
      }
      
      .rating-group {
        gap: 10px;
      }
      
      footer {
        padding: 40px 0 20px 0;
        margin-top: 50px;
      }
    }
  </style>

</head>

<body onload="loadProjectData()">

<div class="top-nav">
  <div class="container d-flex justify-content-between flex-wrap">

    <div>
      <a href="#"><i class="fa fa-question-circle"></i> FAQ</a>
      <a href="https://www.google.com/maps/search/?api=1&query=A-40A Landmark Plaza Mohali" target="_blank">
        <i class="fa fa-map-marker-alt"></i> A-40A, Landmark Plaza, Mohali
      </a>
    </div>

    <div>
      <a href="mailto:abhay@logicapt.com"><i class="fa fa-envelope"></i> abhay@logicapt.com</a>
      <a href="tel:+14157278390"><i class="fa fa-phone"></i> +1 (415) 727 8390</a>

      <a href="https://linkedin.com/company/logicapt"
        target="_blank" class="circle-icon">
        <i class="fa-brands fa-linkedin"></i>
      </a>

      <a href="https://instagram.com/logicaptinformatics/"
        target="_blank" class="circle-icon">
        <i class="fa-brands fa-instagram"></i>
      </a>
    </div>

  </div>
</div>

<header>
  <div class="container d-flex align-items-center justify-content-between">
    <img src="https://raw.githubusercontent.com/ashutoshrana1999/FeedBack_Form/refs/heads/main/image-removebg-preview.png" class="logo" alt="LogicApt Logo" />
    <h1>Client Feedback Form</h1>
  </div>
</header>

<div class="container first-section">
  <div class="form-card">
    <h2 id="project-name" style="color:#ff7f27;">Loading Project...</h2>
    <div id="project-paragraph"></div>

    <div id="loading-spinner" class="text-center">
      <div class="spinner-border text-warning" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading project details...</p>
    </div>

    <p id="error-message" style="display:none; color:red; text-align:center;"></p>
  </div>
</div>

<div class="container">
  <div id="feedback-container" class="form-card fade-in" style="display:none;">

    <p>Thank you for your collaboration. Your feedback helps us improve our services.</p>

    <form id="feedbackForm" novalidate>
      <div class="row mb-3">
        <div class="col-md-4 fw-bold">Overall Rating: <span class="text-danger">*</span></div>
        <div class="col-md-8">
          <div class="rating-group">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="overallRating" id="overallRating1" value="1" required>
              <label class="form-check-label" for="overallRating1">1</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="overallRating" id="overallRating2" value="2">
              <label class="form-check-label" for="overallRating2">2</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="overallRating" id="overallRating3" value="3">
              <label class="form-check-label" for="overallRating3">3</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="overallRating" id="overallRating4" value="4">
              <label class="form-check-label" for="overallRating4">4</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="overallRating" id="overallRating5" value="5">
              <label class="form-check-label" for="overallRating5">5</label>
            </div>
          </div>
          <div class="error-message" id="overallRatingError">Please provide an overall rating</div>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4 fw-bold">Quality of Service: <span class="text-danger">*</span></div>
        <div class="col-md-8">
          <div class="rating-group">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="qualityRating" id="qualityRating1" value="1" required>
              <label class="form-check-label" for="qualityRating1">1</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="qualityRating" id="qualityRating2" value="2">
              <label class="form-check-label" for="qualityRating2">2</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="qualityRating" id="qualityRating3" value="3">
              <label class="form-check-label" for="qualityRating3">3</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="qualityRating" id="qualityRating4" value="4">
              <label class="form-check-label" for="qualityRating4">4</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="qualityRating" id="qualityRating5" value="5">
              <label class="form-check-label" for="qualityRating5">5</label>
            </div>
          </div>
          <div class="error-message" id="qualityRatingError">Please provide a quality rating</div>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4 fw-bold">Timeliness: <span class="text-danger">*</span></div>
        <div class="col-md-8">
          <div class="rating-group">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="timelinessRating" id="timelinessRating1" value="1" required>
              <label class="form-check-label" for="timelinessRating1">1</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="timelinessRating" id="timelinessRating2" value="2">
              <label class="form-check-label" for="timelinessRating2">2</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="timelinessRating" id="timelinessRating3" value="3">
              <label class="form-check-label" for="timelinessRating3">3</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="timelinessRating" id="timelinessRating4" value="4">
              <label class="form-check-label" for="timelinessRating4">4</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="timelinessRating" id="timelinessRating5" value="5">
              <label class="form-check-label" for="timelinessRating5">5</label>
            </div>
          </div>
          <div class="error-message" id="timelinessRatingError">Please provide a timeliness rating</div>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4 fw-bold">Communication: <span class="text-danger">*</span></div>
        <div class="col-md-8">
          <div class="rating-group">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="communicationRating" id="communicationRating1" value="1" required>
              <label class="form-check-label" for="communicationRating1">1</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="communicationRating" id="communicationRating2" value="2">
              <label class="form-check-label" for="communicationRating2">2</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="communicationRating" id="communicationRating3" value="3">
              <label class="form-check-label" for="communicationRating3">3</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="communicationRating" id="communicationRating4" value="4">
              <label class="form-check-label" for="communicationRating4">4</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="communicationRating" id="communicationRating5" value="5">
              <label class="form-check-label" for="communicationRating5">5</label>
            </div>
          </div>
          <div class="error-message" id="communicationRatingError">Please provide a communication rating</div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-md-4 fw-bold">Value for Money: <span class="text-danger">*</span></div>
        <div class="col-md-8">
          <div class="rating-group">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="valueRating" id="valueRating1" value="1" required>
              <label class="form-check-label" for="valueRating1">1</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="valueRating" id="valueRating2" value="2">
              <label class="form-check-label" for="valueRating2">2</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="valueRating" id="valueRating3" value="3">
              <label class="form-check-label" for="valueRating3">3</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="valueRating" id="valueRating4" value="4">
              <label class="form-check-label" for="valueRating4">4</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="valueRating" id="valueRating5" value="5">
              <label class="form-check-label" for="valueRating5">5</label>
            </div>
          </div>
          <div class="error-message" id="valueRatingError">Please provide a value rating</div>
        </div>
      </div>

      <div class="mb-4">
        <label for="comments" class="form-label fw-bold">Additional Comments:</label>
        <textarea name="comments" id="comments" class="form-control" 
                  placeholder="Please share any additional feedback..." rows="4"></textarea>
      </div>

      <button type="submit" class="btn btn-primary px-4" id="submit-button">
        Submit Feedback
      </button>
    </form>
  </div>
</div>

<div class="container">
  <div id="thank-you-container" class="form-card text-center" style="display:none;">
    <h2 style="color:#ff7f27;">Thank You for Your Feedback!</h2>
    <p>Your input helps us improve our services.</p>

    <p><strong>Total Submissions:</strong> <span id="total-submissions">Loading…</span></p>
    <p><strong>Average Overall Rating:</strong> <span id="avg-rating">Loading…</span> / 5</p>

    <button onclick="location.reload()" class="btn btn-primary px-4">
      Submit Another
    </button>
  </div>
</div>

<footer>
  <div class="container">
    <div class="row">

      <div class="col-md-4 mb-4">
        <img src="https://raw.githubusercontent.com/ashutoshrana1999/FeedBack_Form/refs/heads/main/image-removebg-preview.png" style="height:55px;" alt="LogicApt Logo" />
        <h4 class="mt-3">Have a project?</h4>
        <p>WE CAN HELP</p>
        <p><a href="mailto:info@logicapt.com" style="color:#ff7f27;">info@logicapt.com</a></p>
      </div>

      <div class="col-md-4 mb-4">
        <h4>Our Office</h4>

        <p><strong>ADDRESS</strong></p>
        <p>
          <a href="https://www.google.com/maps/search/?api=1&query=A-40A Landmark Plaza Mohali" target="_blank">
          <i class="fa fa-map-marker-alt"></i>
          LogicApt Informatics Pvt. Ltd.<br>
          A-40A Landmark Plaza<br>
          Phase VIII Extension<br>
          Mohali - 160059 (Punjab), India
        </a>
        </p>

        <p><strong>PHONE</strong></p>
        <p><strong>India:</strong><br>
          +91 (172) 5093683<br>
          +91 97250 07842
        </p>

        <p><strong>USA:</strong><br>
          +1 (415) 727 8390
        </p>
      </div>

      <div class="col-md-4 mb-4">
        <h4>Find us on social media</h4>

        <div class="footer-social mt-3">
          <a href="https://linkedin.com/company/logicapt" target="_blank">
            <i class="fa-brands fa-linkedin"></i>
          </a>

          <a href="https://instagram.com/logicaptinformatics/" target="_blank">
            <i class="fa-brands fa-instagram"></i>
          </a>

          <a href="https://logicapt.com" target="_blank">
            <i class="fa fa-globe"></i>
          </a>
        </div>
      </div>

    </div>

    <div class="footer-bottom">
      © 2025 LogicApt. All rights reserved.
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// IMPORTANT: Update this URL with your deployed Google Apps Script Web App URL
const FETCH_WEB_APP_URL =
  "https://script.google.com/macros/s/AKfycbwOPQZ6IGDVOhLaToi41ZOhoIg7sFmmwwpwzOnz2HlDmqIglgj5sQ-agX1zOy-CS98/exec";

const SUBMIT_WEB_APP_URL = FETCH_WEB_APP_URL;

// Global variable to store current project data
let currentProjectData = {};

// Utility Functions
function getQueryParam(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
}

function escapeHtml(str) {
  if (str === null || str === undefined) return "";
  return String(str)
    .replace(/&/g, "&")
    .replace(/</g, "<")
    .replace(/>/g, ">")
    .replace(/"/g, """)
    .replace(/'/g, "'");
}

function setLoadingState(loading) {
  const submitBtn = document.getElementById("submit-button");
  if (!submitBtn) return;

  if (loading) {
    submitBtn.disabled = true;
    submitBtn.innerHTML =
      '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...';
  } else {
    submitBtn.disabled = false;
    submitBtn.textContent = "Submit Feedback";
  }
}

function parseProjectFromUrl() {
  const pParam = getQueryParam("p");
  const clientParam = getQueryParam("clientCode") || getQueryParam("client_code");
  const projectParam = getQueryParam("projectCode") || getQueryParam("project_code");

  if (pParam) {
    console.log("p parameter found:", pParam);
    const cleanParam = pParam.replace(/^\/+|\/+$/g, "");
    const parts = cleanParam.split("/").filter((part) => part.trim() !== "");

    if (parts.length >= 2) {
      return {
        clientCode: parts[0],
        projectCode: parts[1],
      };
    }
  } else if (clientParam && projectParam) {
    return {
      clientCode: clientParam,
      projectCode: projectParam,
    };
  }

  return null;
}

async function loadProjectData() {
  console.log("Starting loadProjectData");
  
  const spinner = document.getElementById("loading-spinner");
  const projectNameEl = document.getElementById("project-name");
  const errorMsgEl = document.getElementById("error-message");
  
  errorMsgEl.style.display = "none";

  const project = parseProjectFromUrl();
  
  if (!project) {
    if (spinner) spinner.style.display = "none";
    if (projectNameEl) projectNameEl.textContent = "Error";
    errorMsgEl.textContent = "Invalid URL: Missing clientCode and projectCode parameters.";
    errorMsgEl.style.display = "block";
    return;
  }
  
  console.log("Loading project:", project.clientCode, project.projectCode);
  
  try {
    const projectData = await fetchProjectData(
      project.clientCode, 
      project.projectCode
    );
    displayProjectData(projectData);
    
  } catch (error) {
    console.error("Error loading project:", error);
    
    if (spinner) spinner.style.display = "none";
    if (projectNameEl) projectNameEl.textContent = "Project Not Found";
    errorMsgEl.textContent = "Error: " + (error.message || "Could not retrieve project data.");
    errorMsgEl.style.display = "block";
  }
}

function validateForm() {
  let isValid = true;

  const requiredFields = [
    "overallRating",
    "qualityRating",
    "timelinessRating",
    "communicationRating",
    "valueRating",
  ];

  requiredFields.forEach((field) => {
    const checked = document.querySelector(
      'input[name="' + field + '"]:checked'
    );
    const errorElement = document.getElementById(field + "Error");

    if (!checked) {
      if (errorElement) errorElement.style.display = "block";
      isValid = false;
    } else {
      if (errorElement) errorElement.style.display = "none";
    }
  });

  return isValid;
}

async function fetchProjectData(clientCode, projectCode) {
  const url = `${FETCH_WEB_APP_URL}?clientCode=${encodeURIComponent(clientCode)}&projectCode=${encodeURIComponent(projectCode)}`;

  console.log("Fetch URL:", url);

  try {
    const response = await fetch(url);
    
    if (!response.ok) throw new Error(`HTTP error: ${response.status}`);

    const result = await response.json();
    console.log("Web App response (Fetch):", result);

    if (result.status === "success") return result.project;

    throw new Error(result.message || "Project not found");
  } catch (error) {
    console.error("Error fetching project with fetch. Trying JSONP fallback:", error);
    // Fallback to JSONP
    return await fetchProjectDataJsonp(clientCode, projectCode);
  }
}

function fetchProjectDataJsonp(clientCode, projectCode) {
  return new Promise((resolve, reject) => {
    const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
    const url = `${FETCH_WEB_APP_URL}?clientCode=${encodeURIComponent(clientCode)}&projectCode=${encodeURIComponent(projectCode)}&callback=${callbackName}`;
    
    window[callbackName] = function(data) {
      delete window[callbackName];
      document.body.removeChild(script);
      
      if (data.status === "success") {
        resolve(data.project);
      } else {
        reject(new Error(data.message || "Project not found via JSONP"));
      }
    };
    
    const script = document.createElement('script');
    script.src = url;
    script.onerror = () => {
      delete window[callbackName];
      document.body.removeChild(script);
      reject(new Error('GET request failed (JSONP network error)'));
    };
    
    document.body.appendChild(script);
  });
}

async function submitFeedback(formData, projectData) {
  try {
    setLoadingState(true);

    const submissionData = {
      client_code: String(projectData.client_code),
      project_code: String(projectData.project_code),
      overall_rating: String(formData.overallRating),
      quality_rating: String(formData.qualityRating),
      timeliness_rating: String(formData.timelinessRating),
      communication_rating: String(formData.communicationRating),
      value_rating: String(formData.valueRating),
      additional_comment: String(formData.comments || ""),
    };

    console.log("Submitting data:", submissionData);

    // This method sends data as form-data (application/x-www-form-urlencoded), 
    // which is the correct format for Apps Script's e.parameter
    const response = await submitFeedbackWithForm(submissionData); 

    if (response.status === "success") {
      return { success: true, message: response.message };
    }

    throw new Error(response.message || "Failed to submit feedback");
  } catch (error) {
    console.error("Submission error:", error);
    throw error;
  } finally {
    setLoadingState(false);
  }
}

/**
 * Sends data to Apps Script using a hidden form and iframe, simulating a standard form POST.
 * This ensures the backend receives data in the `e.parameter` object, resolving the JSON error.
 */
function submitFeedbackWithForm(submissionData) {
  return new Promise((resolve, reject) => {
    const iframeName = 'iframe_' + Math.round(100000 * Math.random());
    const iframe = document.createElement('iframe');
    iframe.name = iframeName;
    iframe.style.display = 'none';
    document.body.appendChild(iframe);

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = SUBMIT_WEB_APP_URL;
    form.target = iframeName; // Target the invisible iframe
    form.style.display = 'none';
    
    // Add all data as hidden inputs (sends as form-data)
    Object.keys(submissionData).forEach(key => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = key;
      input.value = submissionData[key];
      form.appendChild(input);
    });
    
    document.body.appendChild(form);
    
    // Setup listener for iframe load, which contains the response from Apps Script
    iframe.onload = function() {
      try {
        const responseText = iframe.contentWindow.document.body.textContent;
        // Parse the JSON response that your Apps Script doPost function is expected to return
        const data = JSON.parse(responseText);
        
        document.body.removeChild(form);
        document.body.removeChild(iframe);
        
        resolve(data);
      } catch (e) {
        document.body.removeChild(form);
        document.body.removeChild(iframe);
        reject(new Error('Failed to parse server response after submission.'));
      }
    };
    
    // Set timeout
    setTimeout(() => {
      if (document.body.contains(iframe)) {
        document.body.removeChild(form);
        document.body.removeChild(iframe);
        reject(new Error('Submission timeout'));
      }
    }, 15000);
    
    form.submit();
  });
}

function displayProjectData(project) {
  const projectNameEl = document.getElementById("project-name");
  const projectParagraphEl = document.getElementById("project-paragraph");

  projectNameEl.textContent = project.project_title || "Unnamed Project";

  const paragraphHtml = generateProjectParagraph(project);

  currentProjectData = project;

  projectParagraphEl.innerHTML = paragraphHtml;

  const spinner = document.getElementById("loading-spinner");
  if (spinner) spinner.style.display = "none";

  const container = document.getElementById("feedback-container");
  if (container) container.style.display = "block";
  
  const errorMsgEl = document.getElementById("error-message");
  if (errorMsgEl) errorMsgEl.style.display = "none";
}

function generateProjectParagraph(project) {
  const type = (project.project_type || "").toString().trim();
  const code = project.project_code || "";
  const client = project.client_code || "";
  const title = project.project_title || "";
  const patent = project.patent_number || "";
  const product = project.product_name || "";

  const t = type.toLowerCase();

  if (
    t.includes("patentability") ||
    t.includes("patentibility") ||
    (t.includes("patent") &&
      (t.includes("search") || t.includes("analysis")))
  ) {
    return (
      "<p>Thank you for collaborating with us on this Patentability Search project.<br>" +
      "Your insights help us assess the inventive step and novelty with accuracy.<br>" +
      "Please provide your feedback to help us improve our search strategies.</p>" +
      "<p><strong>Project Details:</strong><br>" +
      "Project Code: " +
      escapeHtml(code) +
      "<br>Client Code: " +
      escapeHtml(client) +
      "<br>Type: Patentability Search<br>" +
      "Project Title: " +
      escapeHtml(title) +
      (patent ? "<br>Patent Number: " + escapeHtml(patent) : "") +
      "</p><p>Thank you for your valuable partnership.</p>"
    );
  }

  if (
    t.includes("invalidation") ||
    t.includes("invalidity") ||
    t.includes("opposition")
  ) {
    return (
      "<p>We appreciate the opportunity to support you in this Invalidation Search project.<br>" +
      "Your feedback helps us refine our methodology.</p>" +
      "<p><strong>Project Details:</strong><br>" +
      "Project Code: " +
      escapeHtml(code) +
      "<br>Client Code: " +
      escapeHtml(client) +
      "<br>Type: Invalidation Search<br>" +
      "Project Title: " +
      escapeHtml(title) +
      "<br>Patent Number: " +
      escapeHtml(patent) +
      "</p><p>Thank you for trusting our expertise.</p>"
    );
  }

  if (
    t.includes("infringement") ||
    t.includes("infringment") ||
    t.includes("freedom") ||
    t.includes("clearance")
  ) {
    return (
      "<p>Thank you for working with us on this Infringement Study project.</p>" +
      "<p><strong>Project Details:</strong><br>" +
      "Project Code: " +
      escapeHtml(code) +
      "<br>Client Code: " +
      escapeHtml(client) +
      "<br>Type: Infringement Study<br>" +
      "Project Title: " +
      escapeHtml(title) +
      "<br>Patent Number: " +
      escapeHtml(patent) +
      "<br>Product Name: " +
      escapeHtml(product) +
      "</p><p>We appreciate your continued collaboration.</p>"
    );
  }

  return (
    "<p>Thank you for collaborating with us on this project.</p>" +
    "<p><strong>Project Details:</strong><br>" +
    "Project Code: " +
    escapeHtml(code) +
    "<br>Client Code: " +
    escapeHtml(client) +
    "<br>Type: " +
    escapeHtml(type || "General Project") +
    "<br>Project Title: " +
    escapeHtml(title) +
    (patent ? "<br>Patent Number: " + escapeHtml(patent) : "") +
    (product ? "<br>Product Name: " + escapeHtml(product) : "") +
    "</p><p>Thank you for your valuable partnership.</p>"
  );
}

function showThankYouPage() {
  const feedback = document.getElementById("feedback-container");
  const thanks = document.getElementById("thank-you-container");

  if (feedback) feedback.style.display = "none";
  if (thanks) thanks.style.display = "block";

  // Delay stats load to allow Google Sheets to update (backend lock flush)
  setTimeout(() => {
    loadStats();
  }, 1500);
}

async function loadStats() {
  try {
    const statsUrl = `${currentProjectData.client_code}/${currentProjectData.project_code}&stats=1`;
    
    // Use JSONP fetch for reliable cross-origin GET requests
    const stats = await fetchProjectDataJsonp(currentProjectData.client_code, currentProjectData.project_code + "&stats=1");

    if (stats) {
      document.getElementById("total-submissions").textContent = 
        stats.total_submissions || "0";
      // Format rating to one decimal place if it exists
      document.getElementById("avg-rating").textContent = 
        (stats.average_rating ? parseFloat(stats.average_rating).toFixed(1) : "0.0");
    }
  } catch (error) {
    console.error("Error loading stats:", error);
    // Fallback values on error
    document.getElementById("total-submissions").textContent = "N/A";
    document.getElementById("avg-rating").textContent = "N/A";
  }
}

// ---------------- EVENT LISTENER --------------------
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("feedbackForm");
  
  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!validateForm()) {
        console.log("Form validation failed.");
        return;
      }

      // Collect form data manually for POST request
      const formData = {
        overallRating: document.querySelector('input[name="overallRating"]:checked')?.value,
        qualityRating: document.querySelector('input[name="qualityRating"]:checked')?.value,
        timelinessRating: document.querySelector('input[name="timelinessRating"]:checked')?.value,
        communicationRating: document.querySelector('input[name="communicationRating"]:checked')?.value,
        valueRating: document.querySelector('input[name="valueRating"]:checked')?.value,
        comments: document.getElementById("comments").value,
      };

      try {
        const result = await submitFeedback(formData, currentProjectData);
        if (result.success) {
          showThankYouPage();
        } else {
          alert("Submission failed: " + result.message);
        }
      } catch (error) {
        alert("An error occurred during submission: " + error.message);
      }
    });
  }
});
</script>
</body>
</html>
