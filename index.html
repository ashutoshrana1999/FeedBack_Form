<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LogicApt - Client Feedback Form</title>

  <!-- BOOTSTRAP -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- ICONS -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background-color: #f5f6fa;
      color: #333;
    }

    a { text-decoration: none; }

    /* TOP BAR */
    .top-nav {
      background: #000;
      color: #fff;
      padding: 8px 0;
      font-size: 14px;
      border-bottom: 1px solid #222;
    }

    .top-nav a {
      color: #c8cdd6;
      margin-right: 20px;
    }

    .circle-icon {
      width: 28px;
      height: 28px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      color: #fff;
      font-size: 13px;
      margin-left: 10px;
    }

    /* HEADER */
    header {
      background: #fff;
      padding: 15px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .logo { height: 70px; }

    h1 {
      color: #ff7f27;
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }

    /* CARD */
    .form-card {
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }

    /* Fade-in animation */
    .fade-in {
      opacity: 0;
      animation: fadeIn 0.9s forwards ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* FIX: GAP BETWEEN HEADER & FIRST CARD */
    .first-section {
      margin-top: 40px;
    }

    /* FOOTER */
    footer {
      background: #fff;
      padding: 60px 0 30px 0;
      border-top: 1px solid #ddd;
      margin-top: 70px;
    }

    .footer-social a {
      border: 2px solid #ff7f27;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      margin-right: 12px;
      color: #ff7f27;
      font-size: 17px;
    }

    .footer-bottom {
      text-align: center;
      margin-top: 30px;
      color: #666;
      font-size: 14px;
    }
  </style>

</head>

<body>

<!-- TOP BAR -->
<div class="top-nav">
  <div class="container d-flex justify-content-between flex-wrap">

    <div>
      <a href="#"><i class="fa fa-question-circle"></i> FAQ</a>
      <a href="https://www.google.com/maps/search/?api=1&query=A-40A Landmark Plaza Mohali" target="_blank">
        <i class="fa fa-map-marker-alt"></i> A-40A, Landmark Plaza, Mohali
      </a>
    </div>

    <div>
      <a href="mailto:abhay@logicapt.com"><i class="fa fa-envelope"></i> abhay@logicapt.com</a>
      <a href="tel:+14157278390"><i class="fa fa-phone"></i> +1 (415) 727 8390</a>

      <a href="https://linkedin.com/company/logicapt"
         target="_blank" class="circle-icon">
        <i class="fa-brands fa-linkedin"></i>
      </a>

      <a href="https://instagram.com/logicaptinformatics/"
         target="_blank" class="circle-icon">
        <i class="fa-brands fa-instagram"></i>
      </a>
    </div>

  </div>
</div>

<!-- HEADER -->
<header>
  <div class="container d-flex align-items-center justify-content-between">
    <img src="static/image-removebg-preview.png" class="logo" />
    <h1>Client Feedback Form</h1>
  </div>
</header>

<!-- PROJECT INFO -->
<div class="container first-section">
  <div class="form-card">
    <h2 id="project-name" style="color:#ff7f27;">Loading Project...</h2>
    <div id="project-paragraph"></div>

    <div id="loading-spinner" class="text-center">
      <p>Loading project details...</p>
    </div>

    <p id="error-message" style="display:none; color:red; text-align:center;"></p>
  </div>
</div>

<!-- FEEDBACK FORM -->
<div class="container">
  <div id="feedback-container" class="form-card fade-in" style="display:none;">

    <p>Thank you for your collaboration. Your feedback helps us improve our services.</p>

    <form id="feedbackForm">
      <div class="row mb-3">
        <div class="col-md-4 fw-bold">Overall Rating:</div>
        <div class="col-md-8">
          <input type="radio" name="overallRating" value="1"> 1
          <input type="radio" name="overallRating" value="2"> 2
          <input type="radio" name="overallRating" value="3"> 3
          <input type="radio" name="overallRating" value="4"> 4
          <input type="radio" name="overallRating" value="5"> 5
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4 fw-bold">Quality of Service:</div>
        <div class="col-md-8">
          <input type="radio" name="qualityRating" value="1"> 1
          <input type="radio" name="qualityRating" value="2"> 2
          <input type="radio" name="qualityRating" value="3"> 3
          <input type="radio" name="qualityRating" value="4"> 4
          <input type="radio" name="qualityRating" value="5"> 5
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4 fw-bold">Timeliness:</div>
        <div class="col-md-8">
          <input type="radio" name="timelinessRating" value="1"> 1
          <input type="radio" name="timelinessRating" value="2"> 2
          <input type="radio" name="timelinessRating" value="3"> 3
          <input type="radio" name="timelinessRating" value="4"> 4
          <input type="radio" name="timelinessRating" value="5"> 5
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4 fw-bold">Communication:</div>
        <div class="col-md-8">
          <input type="radio" name="communicationRating" value="1"> 1
          <input type="radio" name="communicationRating" value="2"> 2
          <input type="radio" name="communicationRating" value="3"> 3
          <input type="radio" name="communicationRating" value="4"> 4
          <input type="radio" name="communicationRating" value="5"> 5
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-md-4 fw-bold">Value for Money:</div>
        <div class="col-md-8">
          <input type="radio" name="valueRating" value="1"> 1
          <input type="radio" name="valueRating" value="2"> 2
          <input type="radio" name="valueRating" value="3"> 3
          <input type="radio" name="valueRating" value="4"> 4
          <input type="radio" name="valueRating" value="5"> 5
        </div>
      </div>

      <textarea name="comments" class="form-control mb-4"
                placeholder="Additional comments..." rows="4"></textarea>

      <button class="btn btn-warning px-4" style="background:#ff7f27; color:#fff;">
        Submit Feedback
      </button>
    </form>
  </div>
</div>

<!-- THANK YOU -->
<div class="container">
  <div id="thank-you-container" class="form-card text-center" style="display:none;">
    <h2 style="color:#ff7f27;">Thank You for Your Feedback!</h2>
    <p>Your input helps us improve our services.</p>

    <p><strong>Total Submissions:</strong> <span id="total-submissions">Loading…</span></p>
    <p><strong>Average Overall Rating:</strong> <span id="avg-rating">Loading…</span> / 5</p>

    <button onclick="location.reload()" class="btn btn-warning px-4"
            style="background:#ff7f27; color:#fff;">
      Submit Another
    </button>
  </div>
</div>

<!-- FOOTER -->
<footer>
  <div class="container">
    <div class="row">

      <!-- COLUMN 1 -->
      <div class="col-md-4 mb-4">
        <img src="static/image-removebg-preview.png" style="height:55px;" />
        <h4 class="mt-3">Have a project?</h4>
        <p>WE CAN HELP</p>
        <p><a href="mailto:info@logicapt.com" style="color:#ff7f27;">info@logicapt.com</a></p>
      </div>

      <!-- COLUMN 2 -->
      <div class="col-md-4 mb-4">
        <h4>Our Office</h4>

        <p><strong>ADDRESS</strong></p>
        <p>
          <a href="https://www.google.com/maps/search/?api=1&query=A-40A Landmark Plaza Mohali" target="_blank">
        <i class="fa fa-map-marker-alt"></i>
          LogicApt Informatics Pvt. Ltd.<br>
          A-40A Landmark Plaza<br>
          Phase VIII Extension<br>
          Mohali - 160059 (Punjab), India
        </a>
        </p>

        <p><strong>PHONE</strong></p>
        <p><strong>India:</strong><br>
          +91 (172) 5093683<br>
          +91 97250 07842
        </p>

        <p><strong>USA:</strong><br>
          +1 (415) 727 8390
        </p>
      </div>

      <!-- COLUMN 3 -->
      <div class="col-md-4 mb-4">
        <h4>Find us on social media</h4>

        <div class="footer-social mt-3">
          <a href="https://linkedin.com/company/logicapt" target="_blank">
            <i class="fa-brands fa-linkedin"></i>
          </a>

          <a href="https://instagram.com/logicaptinformatics/" target="_blank">
            <i class="fa-brands fa-instagram"></i>
          </a>

          <a href="https://logicapt.com" target="_blank">
            <i class="fa fa-globe"></i>
          </a>
        </div>
      </div>

    </div>

    <div class="footer-bottom">
      &copy; 2025 LogicApt. All rights reserved.
    </div>
  </div>
</footer>

<!-- BOOTSTRAP JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/*
 Google Sheets -> Web page integration with dynamic paragraph generation
 Expected sheet headers (case-insensitive):
  - Sr. no.
  - Project Code
  - Client Code
  - Project Type
  - Project Title
  - Patent Number
  - Generated Link

 The script normalizes headers into keys like:
   sr_no, project_code, client_code, project_type, project_title, patent_number, generated_link

 Use query params to choose row:
  - ?projectIndex=0  (0-based index)
  - ?projectId=XYZ    (matches Project Code / project_code)

 Replace SHEET_ID with your spreadsheet id and set SHEET_NAME if needed.
*/

const SHEET_ID = '1yxn338O8GbNq-UDJiJDpcX4t7U8TNZYKnL99I-nJfyw';
const SHEET_NAME = 'Project_Data';

function getQueryParam(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
}

function parseGviz(text) {
  const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]+)\);/);
  if (!match) throw new Error('Unexpected gviz response format');
  return JSON.parse(match[1]);
}

function normalizeHeader(label) {
  if (!label) return '';
  return label.toString().trim()
    .toLowerCase()
    .replace(/\s+/g, '_')
    .replace(/[^\w_]/g, ''); // remove non-word except underscore
}

// Convert a table row to an object with normalized header keys
function rowToObject(table, rowIndex) {
  const obj = {};
  const cols = table.cols; // array of {id, label, type}
  const row = table.rows[rowIndex];
  cols.forEach((col, i) => {
    const rawLabel = (col && col.label) ? col.label.toString() : `col${i}`;
    const key = normalizeHeader(rawLabel);
    const cell = (row && row.c && row.c[i]) ? row.c[i].v : null;
    obj[key] = cell;
  });
  return obj;
}

function showError(message) {
  document.getElementById('loading-spinner').style.display = 'none';
  const err = document.getElementById('error-message');
  err.style.display = 'block';
  err.innerText = message;
}

// Build dynamic paragraph(s) based on project_type
function generateParagraph(project) {
  const type = (project.project_type || '').toString().trim();
  const code = project.project_code || project.projectcode || '';
  const client = project.client_code || project.clientcode || '';
  const title = project.project_title || project.projecttitle || '';
  const patent = project.patent_number || project.patentnumber || '';
  const product = project.product_mapped || project.productname || project.product_name || project.product || '';

  // Normalize for matching
  const t = type.toLowerCase();

  // Templates from the user, filled with values
  if (t.includes('patentability')) {
    return `
      <p>Thank you for collaborating with us on this Patentability Search project.<br>
      Your insights help us assess the inventive step and novelty with accuracy.<br>
      Please provide your feedback to help us improve our search strategies.</p>

      <p><strong>Project Details:</strong><br>
      Project Code: ${escapeHtml(code)}<br>
      Client Code: ${escapeHtml(client)}<br>
      Type: Patentability Search<br>
      Project Title: ${escapeHtml(title)}</p>

      <p>Thank you for your valuable partnership.</p>
    `;
  } else if (t.includes('invalidation')) {
    return `
      <p>We appreciate the opportunity to support you in this Invalidation Search project.<br>
      Your feedback helps us refine our methodology for identifying prior art and analysing patent strength.</p>

      <p><strong>Project Details:</strong><br>
      Project Code: ${escapeHtml(code)}<br>
      Client Code: ${escapeHtml(client)}<br>
      Type: Invalidation Search<br>
      Project Title: ${escapeHtml(title)}<br>
      Patent Number: ${escapeHtml(patent)}</p>

      <p>Thank you for trusting our expertise.</p>
    `;
  } else if (t.includes('infringement')) {
    return `
      <p>Thank you for working with us on this Infringement Study project.<br>
      Your feedback enables us to improve our evaluation of claim mapping and product analysis.</p>

      <p><strong>Project Details:</strong><br>
      Project Code: ${escapeHtml(code)}<br>
      Client Code: ${escapeHtml(client)}<br>
      Type: Infringement Study<br>
      Project Title: ${escapeHtml(title)}<br>
      Patent Number: ${escapeHtml(patent)}<br>
      Product Name: ${escapeHtml(product)}</p>

      <p>We appreciate your continued collaboration.</p>
    `;
  } else {
    // Generic fallback
    return `
      <p><strong>Project Details:</strong><br>
      Project Code: ${escapeHtml(code)}<br>
      Client Code: ${escapeHtml(client)}<br>
      Type: ${escapeHtml(type || 'Unknown')}<br>
      Project Title: ${escapeHtml(title)}${patent ? `<br>Patent Number: ${escapeHtml(patent)}` : ''}${product ? `<br>Product Name: ${escapeHtml(product)}` : ''}</p>
    `;
  }
}

function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

async function loadProjectFromSheet() {
  if (SHEET_ID === 'REPLACE_WITH_YOUR_SHEET_ID') {
    // keep previous simulated content as fallback so page remains functional for testing
    document.getElementById("project-name").innerText = "Project Name Example";
    document.getElementById("project-paragraph").innerHTML = "<p>Client details loaded successfully.</p><p>Here is the full project description.</p>";
    document.getElementById("loading-spinner").style.display = "none";
    document.getElementById("feedback-container").style.display = "block";
    return;
  }

  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error('Network response was not ok: ' + res.status);
    const text = await res.text();
    const json = parseGviz(text);
    const table = json.table;

    if (!table || !table.rows || table.rows.length === 0) {
      showError('No project data found in the sheet.');
      return;
    }

    // Choose a row: projectIndex or projectId (match Project Code)
    const projectIndexParam = getQueryParam('projectIndex');
    const projectIdParam = getQueryParam('projectId');

    let chosenRowIndex = 0;
    if (projectIndexParam !== null) {
      const idx = parseInt(projectIndexParam, 10);
      if (!isNaN(idx) && idx >= 0 && idx < table.rows.length) {
        chosenRowIndex = idx;
      }
    } else if (projectIdParam !== null) {
      // find column index for project code (try normalized header matches)
      const idColIndex = table.cols.findIndex(c => {
        const label = (c.label || '').toString().toLowerCase().replace(/\s+/g,'');
        return label === 'projectcode' || label === 'project_code' || label === 'projectcode' || label === 'projectid' || label === 'projectcode';
      });
      if (idColIndex >= 0) {
        const found = table.rows.findIndex(r => {
          const cell = r.c && r.c[idColIndex] ? r.c[idColIndex].v : null;
          return String(cell) === projectIdParam;
        });
        if (found >= 0) chosenRowIndex = found;
      } else {
        // If Project Code header not found, search all cells for exact match
        const foundAny = table.rows.findIndex(r => (r.c || []).some(c => (c && c.v) && String(c.v) === projectIdParam));
        if (foundAny >= 0) chosenRowIndex = foundAny;
      }
    }

    const project = rowToObject(table, chosenRowIndex);

    // Use project title if present for heading
    const heading = project.project_title || project.projecttitle || project.title || project.name || project.project_code || 'Unnamed Project';
    document.getElementById("project-name").innerText = heading;

    // Generate the dynamic paragraph based on project_type
    const paragraphHtml = generateParagraph(project);

    // If there's a generated_link field, append a link
    const link = project.generated_link || project.generatedlink || project['generated_link'] || '';
    const linkHtml = link ? `<p><a href="${escapeHtml(link)}" target="_blank">Open generated link</a></p>` : '';

    document.getElementById("project-paragraph").innerHTML = paragraphHtml + linkHtml;

    document.getElementById("loading-spinner").style.display = "none";
    document.getElementById("feedback-container").style.display = "block";

  } catch (err) {
    console.error(err);
    showError('Unable to fetch project data: ' + (err.message || err));
  }
}

// Start
loadProjectFromSheet();
</script>

</body>
</html>
